(function(){var f,j,q,m,p,o,s;"undefined"!=typeof require?(f=require("underscore"),j=require("backbone"),exports=module.exports=j):(f=this._,j=this.Backbone),q=j.Model,m=j.Collection,p=q.prototype,s=/[\.\[\]]+/g,j.Many="Many",j.One="One",o=j.AssociatedModel=q.extend({relations:void 0,_proxyCalls:void 0,get:function(e){var t=p.get.call(this,e);return t?t:this.getAttr.apply(this,arguments)},set:function(e,t,n){var i,u,a,l,c=this;f.isObject(e)||e==null?(i=e,n=t):(i={},i[e]=t);if(!i)return this;for(u in i)a||(a={}),u.match(s)?(e=r(u),t=f.initial(e),e=e[e.length-1],t=this.get(t),t instanceof o&&(t=a[t.cid]||(a[t.cid]={model:t,data:{}}),t.data[e]=i[u])):(t=a[this.cid]||(a[this.cid]={model:this,data:{}}),t.data[u]=i[u]);if(!a)return this.setAttr.call(this,i,n);for(l in a)t=a[l],this.setAttr.call(t.model,t.data,n)||(c=!1);return c},setAttr:function(b,a){var d;a||(a={});if(a.unset)for(d in b)b[d]=void 0;return this.relations&&f.each(this.relations,function(c){var e=c.key,d=c.relatedModel,h=c.collectionType
,g,i,l,n;if(b[e]){g=f.result(b,e),d&&f.isString(d)&&(d=eval(d)),h&&f.isString(h)&&(h=eval(h)),i=c.options?f.extend({},c.options,a):a;if(c.type===j.Many){if(h&&!h.prototype instanceof m)throw Error("collectionType must inherit from Backbone.Collection");g instanceof m?(l=g,b[e]=l):this.attributes[e]?(this.attributes[e].reset(g,i),delete b[e]):(l=h?new h:this._createCollection(d),l.add(g,i),b[e]=l)}else c.type===j.One&&d&&(l=g instanceof o?g:new d(g),b[e]=l);(n=l)&&!n._proxyCallback&&(n._proxyCallback=function(){return this._bubbleEvent.call(this,e,n,arguments)},n.on("all",n._proxyCallback,this))}},this),p.set.call(this,b,a)},_bubbleEvent:function(e,t,n){var i=n[0].split(":"),s=i[0],u=n[1],a=-1,l=t._proxyCalls,c;f.size(i)>1&&(c=i[1]);if(t instanceof m&&"change"===s&&u){var h=r(c),p=f.initial(h);(i=t.find(function(e){var t=e.get(h);return u===(t instanceof o||t instanceof m)?t:e.get(p)||e}))&&(a=t.indexOf(i))}c=e+(a!==-1?"["+a+"]":"")+(c?"."+c:""),n[0]=s+":"+c;if(l){if(a=f.find(l,function(
e,t){return c.indexOf(t,c.length-t.length)!==-1}))return this}else l=t._proxyCalls={};return l[c]=!0,"change"===s&&(this._previousAttributes[e]=t._previousAttributes,this.changed[e]=t),this.trigger.apply(this,n),c&&l&&delete l[c],this},_createCollection:function(b){var a=b;f.isString(a)&&(a=eval(a));if(!(a&&a.prototype instanceof o))throw Error("type must inherit from Backbone.AssociatedModel");return b=new m,b.model=a,b},toJSON:function(e){var t,n;return this.visited||(this.visited=!0,t=p.toJSON.apply(this,arguments),this.relations&&f.each(this.relations,function(r){var i=this.attributes[r.key];i&&(n=i.toJSON(e),t[r.key]=f.isArray(n)?f.compact(n):n)},this),delete this.visited),t},clone:function(){return new this.constructor(this.toJSON())},getAttr:function(e){var t=this,e=r(e),n,i;if(!(f.size(e)<1)){for(i=0;i<e.length;i++){n=e[i];if(!t)break;t=t instanceof m&&!isNaN(n)?t.at(n):t.attributes[n]}return t}}});var t=/[^\.\[\]]+/g,r=function(e){return e===""?[""]:f.isString(e)?e.match(t):e||
[]}}).call(this);