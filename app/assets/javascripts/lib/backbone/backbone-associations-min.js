(function(){var f,j,q,m,p,o,s;"undefined"!==typeof require?(f=require("underscore"),j=require("backbone"),exports=module.exports=j):(f=this._,j=this.Backbone);q=j.Model;m=j.Collection;p=q.prototype;s=/[\.\[\]]+/g;j.Many="Many";j.One="One";o=j.AssociatedModel=q.extend({relations:void 0,_proxyCalls:void 0,get:function(b){var a=p.get.call(this,b);return a?a:this.getAttr.apply(this,arguments)},set:function(b,a,d){var c,e,k,h,g=this;if(f.isObject(b)||b==null){c=b;d=a}else{c={};c[b]=a}if(!c)return this;
for(e in c){k||(k={});if(e.match(s)){b=r(e);a=f.initial(b);b=b[b.length-1];a=this.get(a);if(a instanceof o){a=k[a.cid]||(k[a.cid]={model:a,data:{}});a.data[b]=c[e]}}else{a=k[this.cid]||(k[this.cid]={model:this,data:{}});a.data[e]=c[e]}}if(k)for(h in k){a=k[h];this.setAttr.call(a.model,a.data,d)||(g=false)}else return this.setAttr.call(this,c,d);return g},setAttr:function(b,a){var d;a||(a={});if(a.unset)for(d in b)b[d]=void 0;this.relations&&f.each(this.relations,function(c){var e=c.key,d=c.relatedModel,
h=c.collectionType,g,i,l,n;if(b[e]){g=f.result(b,e);d&&f.isString(d)&&(d=eval(d));h&&f.isString(h)&&(h=eval(h));i=c.options?f.extend({},c.options,a):a;if(c.type===j.Many){if(h&&!h.prototype instanceof m)throw Error("collectionType must inherit from Backbone.Collection");if(g instanceof m){l=g;b[e]=l}else if(this.attributes[e]){this.attributes[e].reset(g,i);delete b[e]}else{l=h?new h:this._createCollection(d);l.add(g,i);b[e]=l}}else if(c.type===j.One&&d){l=g instanceof o?g:new d(g);b[e]=l}if((n=l)&&
!n._proxyCallback){n._proxyCallback=function(){return this._bubbleEvent.call(this,e,n,arguments)};n.on("all",n._proxyCallback,this)}}},this);return p.set.call(this,b,a)},_bubbleEvent:function(b,a,d){var c=d[0].split(":"),e=c[0],k=d[1],h=-1,g=a._proxyCalls,i;f.size(c)>1&&(i=c[1]);if(a instanceof m&&"change"===e&&k){var l=r(i),j=f.initial(l);(c=a.find(function(a){var b=a.get(l);return k===(b instanceof o||b instanceof m)?b:a.get(j)||a}))&&(h=a.indexOf(c))}i=b+(h!==-1?"["+h+"]":"")+(i?"."+i:"");d[0]=
e+":"+i;if(g){if(h=f.find(g,function(a,b){return i.indexOf(b,i.length-b.length)!==-1}))return this}else g=a._proxyCalls={};g[i]=true;if("change"===e){this._previousAttributes[b]=a._previousAttributes;this.changed[b]=a}this.trigger.apply(this,d);i&&g&&delete g[i];return this},_createCollection:function(b){var a=b;f.isString(a)&&(a=eval(a));if(a&&a.prototype instanceof o){b=new m;b.model=a}else throw Error("type must inherit from Backbone.AssociatedModel");return b},toJSON:function(b){var a,d;if(!this.visited){this.visited=
true;a=p.toJSON.apply(this,arguments);this.relations&&f.each(this.relations,function(c){var e=this.attributes[c.key];if(e){d=e.toJSON(b);a[c.key]=f.isArray(d)?f.compact(d):d}},this);delete this.visited}return a},clone:function(){return new this.constructor(this.toJSON())},getAttr:function(b){var a=this,b=r(b),d,c;if(!(f.size(b)<1)){for(c=0;c<b.length;c++){d=b[c];if(!a)break;a=a instanceof m&&!isNaN(d)?a.at(d):a.attributes[d]}return a}}});var t=/[^\.\[\]]+/g,r=function(b){return b===""?[""]:f.isString(b)?
b.match(t):b||[]}}).call(this);
