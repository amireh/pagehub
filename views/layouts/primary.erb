<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <% if false then this_title = yield_with_default(:title) do %><%= AppTitle %><% end end %>
  <% this_title = yield_content(:title) %>
  <title><%= title(this_title) %></title>

  <link href="/assets/app.css" rel="stylesheet" type="text/css" />

  <%= yield_content :css %>

  <script>
    pagehub_hooks = [];
  </script>

  <script src="/assets/vendor/jquery-1.9.1.min.js"></script>

  <%= yield_content :js %>
  <%= yield_content :scripts %>
</head>

<body class="member <%= current_user.p('skin') %>">

  <%= yield_content :wraps %>

  <header id="header">
    <div class="stuff">
      <!-- <h1><a href="/">Page<em>Hub</em></a></h1> -->
      <div id="path" class="path">
      </div>

      <nav>
        <span class="avatar">
          <!-- <a id="cuser_settings_link" href="<%= current_user.settings_url %>" %><%= current_user.nickname %></a> -->
          <% if true || settings.production? %>
            <%= gravatar_tag (current_user.gravatar_email || current_user.email), :icon, { html: { rel: "tooltip", title: current_user.nickname } } %>
          <% end %>
        </span>
        <a class="icon dashboard <%= nav_highlight 'dashboard' %>" rel="tooltip" title="Your dashboard" href="<%= current_user.dashboard_url %>">Dashboard</a>

        <!-- <a class="listlike icon help" href="/help" rel="tooltip" title="Help">Help</a> -->
        <%#= partial "/shared/_nav_help_links" %>
        <a href="<%= current_user.settings_url %>" class="icon tools <%= nav_highlight 'settings' %>" rel="tooltip" title="Account settings">Settings</a>
        <a href="/sessions/destroy" class="icon signout" rel="tooltip" title="Sign out">Sign out</a>
      </nav>
    </div>
  </header>

  <div class="status-wrap">
    <div id="status"></div>
    <%= partial "layouts/_flashes" %>
  </div>

  <div class="stuff">
    <% klasses = [ request.path.gsub('/', ' ').strip.sanitize.split('-').first ] %>
    <% klasses << (yield_content :section if content_for?(:section)) %>

    <div id="content" class="<%= klasses.join(' ') %>">
      <%= yield %>
    </div>

    <%# partial "shared/_skin_switcher" %>

    <div id="loader" class="loader"></div>
    <div class="loader-overlay"></div>

    <aside class="hidden modal alert" id="html5_compatibility_notice">
      <h2>Unsupported Browser</h2>

      <p>The brower you are currently using does not appear to support
        the latest HTML5 standards which are required for PageHub to
        function correctly.
      </p>
      <p>Please update your browser or use a recent version of the
        officially supported browsers: Google Chrome, Safari 5, or Mozilla Firefox.
      </p>
    </aside>

  </div>
  <%= partial "layouts/_footer" %>

  <script>
    <% if settings.development? %>app = null;<% end %>

    pagehub_hooks.push(function(application) {
      <% if settings.development? %>app = application;<% end %>
      application.set('preferences', <%= PageHub::Config.defaults['app'].to_json %>);
      require([ 'pagehub', 'views/flash', 'views/header', 'models/user', 'models/space' ],
              function(UI, Flash, Header, User, Space) {

        application.Flash = new Flash(application);
        application.UI = UI;
        application.UI.initialize(application);

        try {
          application.current_user =
            new User(JSON.parse(_.unescape(<%= h(rabl :"/users/show", locals: { user: current_user }).to_json %>)).user);
        } catch(e) {
          console.log(e)
          // TODO: abort with an error
        }
        <% if @user %>
          <% if current_user == @user %>
            application.user = application.current_user;
          <% else %>
            try {
              application.user =
                new User(JSON.parse(_.unescape(<%= h(rabl :"/users/public_show",  object: @user).to_json %>)).user);
            } catch(e) {
              console.log(e)
            }
          <% end %>
        <% end %>
        <% if @space %>
          // try {
            application.space =
              new Space(JSON.parse(_.unescape(<%= h(rabl :"/spaces/show", object: @space).to_json %>)).space);
            <% if @space.creator == @user %>
              application.space.creator = application.user;
            <% elsif @space.creator == current_user %>
              application.space.creator = application.current_user;
            <% else %>
              try {
                application.space.creator =
                  new User(JSON.parse(_.unescape(<%= h(rabl :"/users/public_show", locals: { user: @space.creator }).to_json %>)).user);
              } catch(e) {
                console.log(e)
              }
            <% end %>

          // } catch(e) {
          //   console.log(e)
          // }
        <% end %>

        application.header = new Header(application);

        <%= (yield_content :deferred_js).gsub(/\<\/?script\>/, '').strip %>

        // application.on('bootstrapped', function() { console.log('bootstrapped') })
        // application.trigger('bootstrapped', application);
      });
    });
  </script>

  <script data-main="/assets/main" src="/assets/lib/require.js"></script>

  <%= partial "layouts/_google_analytics" %>
</body>

</html>
